@model OnlineBookStore_Entities.Book
@using OnlineBookStore_Entities

<div class="container-xxl mt-3">

    @* TempData alerts after posting a review *@
    @if (TempData["ReviewSuccess"] is string ok)
    {
        <div class="alert alert-success">@ok</div>
    }
    @if (TempData["ReviewError"] is string err)
    {
        <div class="alert alert-danger">@err</div>
    }

    <div class="row g-4">
        <!-- LEFT: Book details -->
        <div class="col-lg-7">
            <h2 class="mb-3">@Model.Title</h2>
            <p><b>Publisher:</b> @Model.Publisher?.Name</p>
            <p><b>Author:</b> @Model.Author?.Name</p>
            <p><b>Description:</b> @Model.Description</p>
            <p><b>Price:</b> @Model.Price</p>

            <h3 class="mt-4">Reviews</h3>
            @if (!(Model.Reviews?.Any() ?? false))
            {
                <p>No reviews yet.</p>
            }
            else
            {
                <ul>
                    @foreach (var review in (Model.Reviews ?? new List<Review>()).OrderByDescending(r => r.ReviewId))
                    {
                        <li>@review.Content - Rating: @review.Rating</li>
                    }
                </ul>
            }

            <form asp-action="AddToCart" method="post" class="mt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="bookId" value="@Model.BookId" />
                <button type="submit" class="btn btn-primary">Add to Cart</button>
            </form>
        </div>

        <div class="col-lg-5">
            <div class="reviews-panel">
                <h3 class="fw-bold mb-3">Recenzii și comentarii</h3>

                @{
                    var reviews = Model.Reviews ?? new List<Review>();
                    var hasReviews = reviews.Any();
                    var avg = hasReviews ? reviews.Average(r => r.Rating) : 0;
                }

                @* Average rating card (only if there are reviews) *@
                @if (hasReviews)
                {
                    <div class="card shadow-sm mb-3">
                        <div class="card-body d-flex align-items-center gap-2">
                            <div class="fs-5">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <span>@(i <= Math.Round(avg) ? "★" : "☆")</span>
                                }
                            </div>
                            <div class="text-muted">(@avg.ToString("0.0") din 5)</div>
                        </div>
                    </div>
                }

                @* Reviews list / empty state *@
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        @if (!hasReviews)
                        {
                            <div class="text-muted">Nu există recenzii pentru acest produs.</div>
                        }
                        else
                        {
                            <ul class="list-unstyled mb-0">
                                @foreach (var r in reviews.OrderByDescending(r => r.ReviewId))
                                {
                                    <li class="mb-3 pb-3 border-bottom">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="stars fs-5">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <span>@(i <= r.Rating ? "★" : "☆")</span>
                                                }
                                            </div>
                                            <div class="small text-muted">
                                                de @r.User?.Username ?? "Anonim"
                                            </div>
                                        </div>
                                        <div class="mt-2">@r.Content</div>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>

                <h6 class="fw-bold mb-2">Adaugă o recenzie</h6>

                @if (!(User?.Identity?.IsAuthenticated ?? false))
                {
                    <div class="card shadow-sm">
                        <div class="card-body text-muted">
                            Trebuie să te autentifici pentru a adăuga comentarii/recenzii.
                        </div>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <!-- Posts to ReviewsController.Create -->
                            <form asp-controller="Reviews" asp-action="Create" method="post" class="d-grid gap-3">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="BookId" value="@Model.BookId" />

                                <div>
                                    <label class="form-label mb-1">Acordă o notă</label>
                                    <div class="star-rating">
                                        @for (int i = 5; i >= 1; i--)
                                        {
                                            <input type="radio" id="star-@i" name="Rating" value="@i" />
                                            <label for="star-@i" title="@i stele">★</label>
                                        }
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label mb-1" for="Content">Comentariul tău</label>
                                    <textarea id="Content" name="Content" rows="4" class="form-control"
                                          placeholder="Scrie aici părerea ta despre produs..."></textarea>
                                </div>

                                <div>
                                    <button type="submit" class="btn btn-dark">Trimite recenzia</button>
                                </div>
                            </form>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .reviews-panel .card {
        border-radius: 12px;
    }

    .reviews-panel .stars span {
        line-height: 1;
    }

    .star-rating {
        display: inline-flex;
        flex-direction: row-reverse;
    }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 1.6rem;
            cursor: pointer;
            padding: 0 .15rem;
            filter: grayscale(100%);
            opacity: .5;
            transition: transform .05s, opacity .15s;
        }

            .star-rating input:checked ~ label,
            .star-rating label:hover,
            .star-rating label:hover ~ label {
                filter: none;
                opacity: 1;
                transform: scale(1.05);
            }
</style>
